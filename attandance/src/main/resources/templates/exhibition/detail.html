<!DOCTYPE html>
<html lang="en" xmlns:th=" http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Vystoupení Detail</title>
    <link rel="stylesheet" href="../static/css/exhibition.css" th:href="@{/css/exhibition.css}">
</head>
<body>
<div th:include="layout.html"></div>
<div class="page-content">
    <button type="button1" class="btn btn-primary submitForm"><a id="editLink">Editace</a></button>
    <div>
        <!--TODO Action info-->
        <table class="horniTabulka">
            <tr>
                <th><p>Název:</p></th>
                <th><p th:text="${action.actionName}"></p></th>
            </tr>
            <tr>
                <td><p>Datum akce:</p></td>
                <td><p th:text="${action.dateAction}"></p></td>
            </tr>
            <tr>
                <td><p>Typ akce:</p></td>
                <td><p th:text="${action.type}"></p></td>
            </tr>
            <tr>
                <td><p>Město:</p></td>
                <td><p th:text="${action.address.city}"></p></td>
            </tr>
            <tr>
                <td><p>Ulice:</p></td>
                <td><p th:text="${action.address.street}"></p></td>
            </tr>
        </table>
    </div>
    <div>
        <!--TODO Chooser-->
        <div>
            <div class="vyhledavani">
                <div class="form-group" id="userSelect">
                    <label for="user">Uživatel:</label>
                    <select class="custom-select" id="user">
                    </select>
                </div>
                <div class="btnLayout">
                    <button type="button2" class="btn btn-primary submitForm" id="sendUser">Vyhledat</button>
                </div>
                <div class="loader"></div>
            </div>
            <div id="jsGrid"></div>
        </div>
    </div>
</div>
</body>
</html>
<script>
    $(document).ready(function () {
        $("#editLink").attr("href", "/edit/" + [[${action.actionsid}]]);
        let data = [];
        $.ajax({
            url: "/api/v1/user/action/" + "[[${actionid}]]",
            method: "GET",
            success: function (items) {
                for (let i = 0; i < items.length; i++) {
                    let item =
                        {
                            "firstname": "<a href=/profil/user/" + items[i].userid + ">" + items[i].person.firstname + "",
                            "lastname": items[i].person.lastname,
                            "username": items[i].username,
                            "role": items[i].person.role.name
                        };
                    data.push(item);
                }
                renderJsGrid(data);
                fillSelect();
                $(".loader").hide();
            }
        });


        $("#sendUser").on("click", function () {

        });
    });


    $("#sendUser").on('click', function () {
        $.ajax({
            method: "POST",
            url: "/api/v1/useraction",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({
                "userid": $("#user").val(),
                "actionid": "[[${actionid}]]"
            }),
            success: function () {
                $("#jsGrid").jsGrid().reload();
                location.reload();
            }
        })
    });

    function renderJsGrid(data) {
        $("#jsGrid").jsGrid({
            width: "100%",
            height: "100%",

            searching: true,
            sorting: true,

            data: data,

            fields: [
                {name: "firstname", type: "text", title: "Jméno", width: 30},
                {name: "lastname", type: "text", title: "Příjmení", width: 30},
                {name: "username", type: "text", title: "Uživatelské jméno", width: 30},
                {name: "role", type: "text", title: "Typ", width: 30}
            ]
        });
    }

    function fillSelect() {
        let data = $("#jsGrid").jsGrid("option", "data");
        let usernames = prepareIds(data);
        $.ajax({
            method: "GET",
            url: "/api/v1/user",
            success: function (items) {
                items.forEach(function (user) {
                    if (!usernames.includes(user.username)) {
                        $('#user').append(new Option(user.person.firstname + " " + user.person.lastname + " (" + user.person.role.name + ")", user.userid))
                    }
                })
            }
        });
    }

    function prepareIds(data) {
        let usernames = [];
        console.log(data);
        data.forEach(function (user) {
            usernames.push(user.username);
        });
        return usernames;
    }

</script>
